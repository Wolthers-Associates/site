<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Timezone Fix - Wolthers & Associates</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
        }
        .success { border-left: 4px solid #4CAF50; background: #f8fff8; }
        .warning { border-left: 4px solid #ff9800; background: #fff8f0; }
        .error { border-left: 4px solid #f44336; background: #fff5f5; }
        button {
            background: #2C5530;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1e3b21;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #4CAF50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.pending { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Timezone Fix - Live Test</h1>
        <p>This page tests the automatic timezone detection and update system. No login/logout required!</p>
        
        <div class="test-section">
            <h3>1. Browser Timezone Detection</h3>
            <button onclick="testTimezoneDetection()">Test Timezone Detection</button>
            <div id="timezoneResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Server Timezone Conversion Test</h3>
            <button onclick="testServerConversion()">Test Server Conversion</button>
            <div id="serverResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. Database Update Test</h3>
            <p><strong>Requirements:</strong> You must be logged in to trips.wolthers.com in another tab</p>
            <button onclick="testDatabaseUpdate()">Update My Timezone Now</button>
            <div id="databaseResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. Current Database Status</h3>
            <button onclick="checkDatabaseStatus()">Check Database</button>
            <div id="statusResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. Expected Results</h3>
            <ul>
                <li><strong>Your Timezone:</strong> <code id="expectedTimezone">America/Sao_Paulo</code></li>
                <li><strong>Current UTC Time:</strong> <code id="currentUtc"></code></li>
                <li><strong>Your Local Time:</strong> <code id="currentLocal"></code></li>
                <li><strong>Expected Difference:</strong> <code id="timeDifference"></code></li>
            </ul>
        </div>
    </div>

    <script>
        // Update expected results on page load
        function updateExpectedResults() {
            const now = new Date();
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const utcTime = now.toISOString().slice(0, 19).replace('T', ' ');
            const localTime = now.toLocaleString('sv-SE').replace(',', '');
            const offsetMinutes = now.getTimezoneOffset();
            const offsetHours = Math.abs(offsetMinutes / 60);
            const offsetSign = offsetMinutes > 0 ? '-' : '+';
            
            document.getElementById('expectedTimezone').textContent = timezone;
            document.getElementById('currentUtc').textContent = utcTime + ' UTC';
            document.getElementById('currentLocal').textContent = localTime + ' Local';
            document.getElementById('timeDifference').textContent = `UTC${offsetSign}${offsetHours} (${Math.abs(offsetMinutes)} minutes)`;
        }
        
        function testTimezoneDetection() {
            const result = document.getElementById('timezoneResult');
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const locale = Intl.DateTimeFormat().resolvedOptions().locale;
                const now = new Date();
                const offset = now.getTimezoneOffset();
                
                result.innerHTML = `‚úÖ TIMEZONE DETECTION SUCCESS
Detected Timezone: ${timezone}
Browser Locale: ${locale}
UTC Offset: ${offset} minutes (${offset/60} hours)
Current Local Time: ${now.toLocaleString()}
Current UTC Time: ${now.toISOString()}

Status: ${timezone === 'America/Sao_Paulo' ? '‚úÖ Correct Brazilian timezone' : '‚ö†Ô∏è Unexpected timezone'}`;
            } catch (error) {
                result.innerHTML = `‚ùå TIMEZONE DETECTION FAILED
Error: ${error.message}`;
            }
        }
        
        async function testServerConversion() {
            const result = document.getElementById('serverResult');
            result.innerHTML = 'üîÑ Testing server timezone conversion...';
            
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const response = await fetch('api/debug-timezone.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timezone: timezone })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const test = data.debug_info.timezone_test;
                    
                    if (test.conversion_successful) {
                        result.innerHTML = `‚úÖ SERVER CONVERSION SUCCESS
Timezone Used: ${test.timezone_used}
UTC Time: ${test.utc_time}
Local Time: ${test.local_time}
Conversion: ${test.conversion_successful ? 'SUCCESS' : 'FAILED'}

Status: ${test.utc_time !== test.local_time ? '‚úÖ Times are different (correct)' : '‚ö†Ô∏è Times are the same (issue)'}`;
                    } else {
                        result.innerHTML = `‚ùå SERVER CONVERSION FAILED
Error: ${test.error}
Timezone: ${test.timezone_used}`;
                    }
                } else {
                    const error = await response.json();
                    result.innerHTML = `‚ùå SERVER REQUEST FAILED
Status: ${response.status}
Error: ${error.message || 'Unknown error'}`;
                }
            } catch (error) {
                result.innerHTML = `‚ùå CONNECTION ERROR
Error: ${error.message}`;
            }
        }
        
        async function testDatabaseUpdate() {
            const result = document.getElementById('databaseResult');
            result.innerHTML = 'üîÑ Updating your timezone in database...';
            
            try {
                // Try multiple ways to get user session
                let userData = null;
                let session = sessionStorage.getItem('userSession');
                
                if (session) {
                    userData = JSON.parse(session);
                } else {
                    // Try to get session from the main trips site
                    result.innerHTML = 'üîÑ Checking for active session...';
                    
                    try {
                        const sessionCheck = await fetch('api/auth/validate.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include'
                        });
                        
                        if (sessionCheck.ok) {
                            const sessionData = await sessionCheck.json();
                            if (sessionData.user) {
                                userData = { user: sessionData.user };
                            }
                        }
                    } catch (e) {
                        console.log('Session check failed:', e);
                    }
                }
                
                if (!userData) {
                    result.innerHTML = `‚ùå NOT LOGGED IN
Please:
1. Go to trips.wolthers.com in another tab
2. Make sure you're logged in (you should see your name/trips)
3. Come back to this tab and try again

Alternative: Run this in the main trips site console:
autoTimezoneUpdate.forceUpdate()`;
                    return;
                }
                
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                const response = await fetch('api/update-user-timezone.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userData.user.id,
                        timezone: timezone
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.timezone_updated) {
                        result.innerHTML = `‚úÖ DATABASE UPDATE SUCCESS
User ID: ${userData.user.id}
Timezone Updated: ${data.timezone_updated.from} ‚Üí ${data.timezone_updated.to}
${data.timezone_updated.local_time_corrected ? 
  `Local Time Corrected: ${data.timezone_updated.local_time_corrected}
UTC Time Unchanged: ${data.timezone_updated.utc_time_unchanged}` : 
  'No existing timestamps to correct'}

üéâ Your login timestamps should now show in Brazilian time!`;
                    } else {
                        result.innerHTML = `‚ÑπÔ∏è NO UPDATE NEEDED
Current Timezone: ${data.current_timezone}
Status: Already correct`;
                    }
                } else {
                    const error = await response.json();
                    result.innerHTML = `‚ùå DATABASE UPDATE FAILED
Status: ${response.status}
Error: ${error.message || 'Unknown error'}`;
                }
            } catch (error) {
                result.innerHTML = `‚ùå UPDATE ERROR
Error: ${error.message}`;
            }
        }
        
        async function checkDatabaseStatus() {
            const result = document.getElementById('statusResult');
            result.innerHTML = 'üîÑ Checking database status...';
            
            try {
                // Open the debug page in a new window
                window.open('api/debug-db-structure.php', '_blank');
                result.innerHTML = `‚úÖ DATABASE DEBUG PAGE OPENED
Check the new tab to see your current database status.
Look for:
- Last Login (Local): Should show Brazilian time
- Last Login (UTC): Should show UTC time  
- Timezone: Should show "America/Sao_Paulo"`;
            } catch (error) {
                result.innerHTML = `‚ùå ERROR
Could not open database debug page: ${error.message}`;
            }
        }
        
        // Initialize page
        updateExpectedResults();
        setInterval(updateExpectedResults, 1000); // Update every second
    </script>
</body>
</html> 